<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì¼ê¸° ì† ë„ì„œê´€</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='recommend.css') }}">
</head>
<body>
<header>
  <img src="{{ url_for('static', filename='notebook_icon.png') }}" alt="Notebook Icon">
  <a href="../ë©”ì¸/main.html"><h1>ì¼ê¸° ì† ë„ì„œê´€</h1></a>
  <nav>
    <ul>
      <li><a href="../ë„ì„œì¶”ì²œ/recommend.html">ë„ì„œ ì¶”ì²œ</a></li>
      <li><a href="../ë„ì„œí•¨/my_library.html">ë„ì„œí•¨</a></li>
      <li><a href="../ê¸°ë³¸ì„¤ì •/mypage.html">ë‚´ ì •ë³´</a></li>
    </ul>
    <button type="button" class="login-button" onClick="location.href='../ê¸°ë³¸ì„¤ì •/login.html'">ë¡œê·¸ì¸</button>
  </nav>
</header>

<div class="container">
  <!-- ë‚ ì§œ ì„ íƒ ì„¹ì…˜ -->
  <div class="date-picker-container">
    <label id="current-date">ğŸ“…</label>
    <span id="display-date"></span>
  </div>

  <!-- íŒŒì¼ ì—…ë¡œë“œ, ì˜¤ëŠ˜ì˜ ì¼ê¸°, í‚¤ì›Œë“œ ì„¹ì…˜ -->
  <div class="diary-section">
    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="diary-writing" id="diary-writing">
      <div id="speech-bubble" class="speech-bubble">ì¼ê¸° ì‘ì„±í•˜ì!</div>
      <img id="image-preview" class="image-preview" alt="" />
      <button id="upload-button">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
      <input type="file" id="file-upload" accept="image/*" style="display: none;" />
    </div>

    <!-- ê²€ìƒ‰ ì˜µì…˜ ì„¹ì…˜ -->
    <div class="keyword-section">
      <h2>ë„ì„œ ë¶„ì•¼</h2>
      <form>
        <label>
          <input type="radio" name="search-option" value="ì–´ë¦°ì´ ì „ì²´" checked>
          ì–´ë¦°ì´ ì „ì²´
        </label>
        <label>
          <input type="radio" name="search-option" value="ì–´ë¦°ì´ ë¬¸í•™">
          ì–´ë¦°ì´ ë¬¸í•™
        </label>
        <label>
          <input type="radio" name="search-option" value="ì–´ë¦°ì´ êµì–‘">
          ì–´ë¦°ì´ êµì–‘
        </label>
        <label>
          <input type="radio" name="search-option" value="ì–´ë¦°ì´ ë§Œí™”">
          ì–´ë¦°ì´ ë§Œí™”
        </label>
      </form>
      <button id="recommend-button" class="recommend-button">ì¶”ì²œ ë°›ê¸°</button>
    </div>

    <!-- ì˜¤ëŠ˜ì˜ ì¼ê¸° -->
    <div class="today-diary">
      <h2>ì˜¤ëŠ˜ì˜ ì¼ê¸°</h2>
      <textarea id="diary-text" placeholder="ì˜¤ëŠ˜ì˜ í•˜ë£¨ëŠ” ì–´ë• ë‚˜ìš”?" readonly></textarea>
      <p id="image-url" style="word-wrap: break-word; color: blue; cursor: pointer;"></p>
    </div>
  </div>

  <!-- ì¶”ì²œ ë„ì„œ ì„¹ì…˜ -->
  <div class="recommendation">
    <h2>ì¶”ì²œ ë„ì„œ</h2>
    <div class="recommendation-row">
      <!-- ì²« ë²ˆì§¸ ë„ì„œ -->
      <div class="book" id="book1">
        <img id="book-image1" src="{{ url_for('static', filename='BOOK.png') }}" alt="Book Image 1">
        <div class="book-info">
          <h3 id="book-title1"><a href="#" target="_blank" id="book-link1">ë„ì„œ ì œëª©</a></h3>

          <p id="book-author1"></p>
          <div id="book-summary1" class="summary-box">ì¶”ì²œë„ì„œê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
      </div>

      <!-- ë‘ ë²ˆì§¸ ë„ì„œ -->
      <div class="book" id="book2">
        <img id="book-image2" src="{{ url_for('static', filename='BOOK.png') }}" alt="Book Image 2">
        <div class="book-info">
          <h3 id="book-title2"><a href="#" target="_blank" id="book-link2">ë„ì„œ ì œëª©</a></h3>

          <p id="book-author2"></p>
          <div id="book-summary2" class="summary-box">ì¶”ì²œë„ì„œê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
      </div>

      <!-- ì„¸ ë²ˆì§¸ ë„ì„œ -->
      <div class="book" id="book3">
        <img id="book-image3" src="{{ url_for('static', filename='BOOK.png') }}" alt="Book Image 3">
        <div class="book-info">
          <h3 id="book-title3"><a href="#" target="_blank" id="book-link3">ë„ì„œ ì œëª©</a></h3>

          <p id="book-author3"></p>
          <div id="book-summary3" class="summary-box">ì¶”ì²œë„ì„œê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  const fileInput = document.getElementById('file-upload');
  const imagePreview = document.getElementById('image-preview');
  const uploadButton = document.getElementById('upload-button');
  const speechBubble = document.getElementById('speech-bubble');
  const diaryText = document.getElementById('diary-text');
  const recommendButton = document.getElementById('recommend-button');

  // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê³„ì‚°í•˜ê³  í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
  function displayCurrentDate() {
    const dateElement = document.getElementById('display-date');
    const today = new Date();
    const formattedDate = `${today.getFullYear()}ë…„ ${today.getMonth() + 1}ì›” ${today.getDate()}ì¼`;
    dateElement.textContent = formattedDate;
  }

  // í˜ì´ì§€ê°€ ë¡œë“œë  ë•Œ ë‚ ì§œ í‘œì‹œ
  window.onload = displayCurrentDate;

  let uploadedFile = null;

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­
  uploadButton.addEventListener('click', function () {
    fileInput.click();
  });

  // ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
  fileInput.addEventListener('change', function () {
    const file = fileInput.files[0];
    if (file) {
      uploadedFile = file;
      const reader = new FileReader();
      reader.onload = function (e) {
        imagePreview.src = e.target.result;
        imagePreview.style.display = 'block';
        speechBubble.style.display = 'none';
      };
      reader.readAsDataURL(file);
    }
  });

  // ì¶”ì²œ ë°›ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ OCR ìˆ˜í–‰ ë° ê²°ê³¼ ë°˜ì˜
  recommendButton.addEventListener('click', async function () {
    if (!uploadedFile) {
      alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•˜ì„¸ìš”!');
      return;
    }

    const selectedOption = document.querySelector('input[name="search-option"]:checked').value;
    console.log(`ì„ íƒëœ ì˜µì…˜: ${selectedOption}`);

    const formData = new FormData();
    formData.append('file', uploadedFile);
    formData.append('search-option', selectedOption);

    try {
      const response = await fetch('/uploads', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        const result = await response.json();
        console.log('ì„œë²„ ì‘ë‹µ:', result);

        diaryText.value = result.ocr_text || 'OCR ì²˜ë¦¬ ì‹¤íŒ¨';

        const imageUrlElement = document.getElementById('image-url');
        imageUrlElement.textContent = result.image_url || 'ì´ë¯¸ì§€ URL ì—†ìŒ';
        imageUrlElement.onclick = () => {
          if (result.image_url) {
            window.open(result.image_url, '_blank');
          }
        };

        // ì¶”ì²œ ë„ì„œ ì •ë³´ ì¶œë ¥
        const matchedBooks = result.recommendation_result?.matched_books || [];
        if (matchedBooks.length === 0) {
          alert('ì¶”ì²œëœ ë„ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }

        // DOM ì—…ë°ì´íŠ¸
        // DOM ì—…ë°ì´íŠ¸ ë¶€ë¶„
        matchedBooks.forEach((book, index) => {
          if (index >= 3) return;

          const bookImage = document.getElementById(`book-image${index + 1}`);
          const bookTitle = document.getElementById(`book-title${index + 1}`);
          const bookAuthor = document.getElementById(`book-author${index + 1}`);
          const bookSummary = document.getElementById(`book-summary${index + 1}`);
          const bookLink = document.getElementById(`book-link${index + 1}`); // <a> íƒœê·¸ ê°€ì ¸ì˜¤ê¸°

          // ë„ì„œ ì •ë³´ ì—…ë°ì´íŠ¸
          bookImage.src = book.book_img_url || '{{ url_for("static", filename="BOOK.png") }}';
          bookLink.href = book.book_prod_url || '#'; // URL ì„¤ì •
          bookLink.textContent = book.title || 'ì œëª© ì—†ìŒ'; // ë„ì„œ ì œëª© ì„¤ì •
          bookLink.target = '_blank'; // ìƒˆ ì°½ì—ì„œ ì—´ê¸°
          bookAuthor.textContent = `ì €ì: ${book.author || 'ì €ì ì •ë³´ ì—†ìŒ'}`;
          bookSummary.textContent = book.prod_introduction || 'ìš”ì•½ ì •ë³´ ì—†ìŒ';

          // ì œëª© í‘œì‹œ
          bookTitle.classList.add('show');
        });

      } else {
        alert('OCR ìš”ì²­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    } catch (error) {
      console.error('ì„œë²„ ì˜¤ë¥˜:', error);
      alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  });
</script>
</body>
</html>